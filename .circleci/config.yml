version: 2.1 
orbs:
  slack: circleci/slack@4.1
jobs:
  build-frontend:
    docker: 
      - image: circleci/node:13.8.0 
    steps:
      - checkout
      - restore_cache: 
          keys: [frontend-build] 
      - run: 
          name: build frontend
          command: |
            cd frontend
            npm install
            npm run build
      - save_cache:
          paths: [frontend/node_modules]
          key: frontend-build
      - slack/notify:
           channel: $SLACK_DEFAULT_CHANNEL
           event: fail
           template: basic_fail_1
      - slack/notify:
          event: pass
          template: success_tagged_deploy_1

  
  build-backend:
    docker: 
    - image: circleci/node:13.8.0
    steps: 
      - checkout
      - restore_cache:
          keys: [backend-build]
      - run: 
          name: build backend
          command: | 
            cd backend
            npm install
            npm run build
      - save_cache:
         paths: [frontend/node_modules]
         key: backend-build
      - slack/notify:
           channel: $SLACK_DEFAULT_CHANNEL
           event: fail
           template: basic_fail_1
      - slack/notify:
            event: pass
            template: success_tagged_deploy_1
  
  test-frontend:
    docker: 
      - image: circleci/node:13.8.0
    steps: 
      - checkout 
      - restore_cache:
          keys: [frontend-build]
      - run: 
          name: test frontend
          command: | 
            cd frontend
            npm install
            npm run test
  
  test-backend: 
    docker: 
      - image: circleci/node:13.8.0
    steps: 
      - checkout 
      - restore_cache:
          keys: [backend-build] 
      - run: 
          name: test backend
          command: | 
            cd backend
            npm install
            npm run test 
  
  scan-frontend: 
    docker: 
      - image: circleci/node:13.8.0
    
    steps:
      - checkout
      - restore_cache:
          keys: [frontend-build]
      - run: 
          name: scan frontend for security vulnarabilities
          command: | 
              cd frontend
              npm install
              # npm install oauth-sign@^0.9.0
              npm audit fix --audit-level=critical --force
  
  scan-backend:
    docker:
      - image: circleci/node:13.8.0
    
    steps: 
      - checkout
      - run: 
          name: scan backend for security vulnarabilities
          command: | 
            cd backend
            npm install
            # npm install oauth-sign@^0.9.0
            npm audit fix --audit-level=critical --force
      - restore_cache: 
          keys: [backend-build]
workflows: 
  defaults: 
    jobs: 
      - build-frontend:
          context: Clive-context
      - build-backend:
          context: Clive-context
      - test-frontend:
          requires: [build-frontend]
      - test-backend:
          requires: [build-backend]
      - scan-frontend:
          requires: [build-frontend]
      - scan-backend:
          requires: [build-backend]

